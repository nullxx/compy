<!-- Creator     : groff version 1.22.2 -->
<!-- CreationDate: Thu Aug 18 15:08:49 2016 -->
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content="groff -Thtml, see www.gnu.org">
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="Content-Style" content="text/css">
<style type="text/css">
       p       { margin-top: 0; margin-bottom: 0; vertical-align: top }
       pre     { margin-top: 0; margin-bottom: 0; vertical-align: top }
       table   { margin-top: 0; margin-bottom: 0; vertical-align: top }
       h1      { text-align: center }
</style>
<title>MALLOPT</title>

</head>
<body>

<h1 align="center">MALLOPT</h1>

<a href="#NAME">NAME</a><br>
<a href="#SYNOPSIS">SYNOPSIS</a><br>
<a href="#DESCRIPTION">DESCRIPTION</a><br>
<a href="#RETURN VALUE">RETURN VALUE</a><br>
<a href="#ERRORS">ERRORS</a><br>
<a href="#CONFORMING TO">CONFORMING TO</a><br>
<a href="#BUGS">BUGS</a><br>
<a href="#EXAMPLE">EXAMPLE</a><br>
<a href="#SEE ALSO">SEE ALSO</a><br>
<a href="#COLOPHON">COLOPHON</a><br>

<hr>


<h2>NAME
<a name="NAME"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">mallopt &minus;
set memory allocation parameters</p>

<h2>SYNOPSIS
<a name="SYNOPSIS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em"><b>#include
&lt;malloc.h&gt;</b></p>

<p style="margin-left:11%; margin-top: 1em"><b>int
mallopt(int</b> <i>param</i><b>, int</b>
<i>value</i><b>);</b></p>

<h2>DESCRIPTION
<a name="DESCRIPTION"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The
<b>mallopt</b>() function adjusts parameters that control
the behavior of the memory-allocation functions (see
<b>malloc</b>(3)). The <i>param</i> argument specifies the
parameter to be modified, and <i>value</i> specifies the new
value for that parameter.</p>

<p style="margin-left:11%; margin-top: 1em">The following
values can be specified for <i>param</i>: <b><br>
M_CHECK_ACTION</b></p>

<p style="margin-left:22%;">Setting this parameter controls
how glibc responds when various kinds of programming errors
are detected (e.g., freeing the same pointer twice). The 3
least significant bits (2, 1, and 0) of the value assigned
to this parameter determine the glibc behavior, as
follows:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="7%">


<p>Bit 0</p></td>
<td width="3%"></td>
<td width="68%">


<p>If this bit is set, then print a one-line message on
<i>stderr</i> that provides details about the error. The
message starts with the string &quot;***&nbsp;glibc
detected&nbsp;***&quot;, followed by the program name, the
name of the memory-allocation function in which the error
was detected, a brief description of the error, and the
memory address where the error was detected.</p></td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="7%">


<p>Bit 1</p></td>
<td width="3%"></td>
<td width="68%">


<p>If this bit is set, then, after printing any error
message specified by bit 0, the program is terminated by
calling <b>abort</b>(3). In glibc versions since 2.4, if bit
0 is also set, then, between printing the error message and
aborting, the program also prints a stack trace in the
manner of <b>backtrace</b>(3), and prints the
process&rsquo;s memory mapping in the style of
<i>/proc/[pid]/maps</i> (see <b>proc</b>(5)).</p></td></tr>
</table>

<p style="margin-left:22%;">Bit 2 (since glibc 2.4)</p>

<p style="margin-left:32%;">This bit has an effect only if
bit 0 is also set. If this bit is set, then the one-line
message describing the error is simplified to contain just
the name of the function where the error was detected and
the brief description of the error.</p>

<p style="margin-left:22%; margin-top: 1em">The remaining
bits in <i>value</i> are ignored.</p>

<p style="margin-left:22%; margin-top: 1em">Combining the
above details, the following numeric values are meaningful
for <b>M_CHECK_ACTION</b>:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="29%"></td>
<td width="2%">


<p>0</p></td>
<td width="3%"></td>
<td width="66%">


<p>Ignore error conditions; continue execution (with
undefined results).</p></td></tr>
<tr valign="top" align="left">
<td width="29%"></td>
<td width="2%">


<p>1</p></td>
<td width="3%"></td>
<td width="66%">


<p>Print a detailed error message and continue
execution.</p> </td></tr>
<tr valign="top" align="left">
<td width="29%"></td>
<td width="2%">


<p>2</p></td>
<td width="3%"></td>
<td width="66%">


<p>Abort the program.</p></td></tr>
<tr valign="top" align="left">
<td width="29%"></td>
<td width="2%">


<p>3</p></td>
<td width="3%"></td>
<td width="66%">


<p>Print detailed error message, stack trace, and memory
mappings, and abort the program.</p></td></tr>
<tr valign="top" align="left">
<td width="29%"></td>
<td width="2%">


<p>5</p></td>
<td width="3%"></td>
<td width="66%">


<p>Print a simple error message and continue execution.</p></td></tr>
<tr valign="top" align="left">
<td width="29%"></td>
<td width="2%">


<p>7</p></td>
<td width="3%"></td>
<td width="66%">


<p>Print simple error message, stack trace, and memory
mappings, and abort the program.</p></td></tr>
</table>

<p style="margin-left:22%; margin-top: 1em">Since glibc
2.3.4, the default value for the <b>M_CHECK_ACTION</b>
parameter is 3. In glibc version 2.3.3 and earlier, the
default value is 1.</p>

<p style="margin-left:22%; margin-top: 1em">Using a nonzero
<b>M_CHECK_ACTION</b> value can be useful because otherwise
a crash may happen much later, and the true cause of the
problem is then very hard to track down.</p>

<p style="margin-left:11%;"><b>M_MMAP_MAX</b></p>

<p style="margin-left:22%;">This parameter specifies the
maximum number of allocation requests that may be
simultaneously serviced using <b>mmap</b>(2). This parameter
exists because some systems have a limited number of
internal tables for use by <b>mmap</b>(2), and using more
than a few of them may degrade performance.</p>

<p style="margin-left:22%; margin-top: 1em">The default
value is 65,536, a value which has no special significance
and which servers only as a safeguard. Setting this
parameter to 0 disables the use of <b>mmap</b>(2) for
servicing large allocation requests.</p>

<p style="margin-left:11%;"><b>M_MMAP_THRESHOLD</b></p>

<p style="margin-left:22%;">For allocations greater than or
equal to the limit specified (in bytes) by
<b>M_MMAP_THRESHOLD</b> that can&rsquo;t be satisfied from
the free list, the memory-allocation functions employ
<b>mmap</b>(2) instead of increasing the program break using
<b>sbrk</b>(2).</p>

<p style="margin-left:22%; margin-top: 1em">Allocating
memory using <b>mmap</b>(2) has the significant advantage
that the allocated memory blocks can always be independently
released back to the system. (By contrast, the heap can be
trimmed only if memory is freed at the top end.) On the
other hand, there are some disadvantages to the use of
<b>mmap</b>(2): deallocated space is not placed on the free
list for reuse by later allocations; memory may be wasted
because <b>mmap</b>(2) allocations must be page-aligned; and
the kernel must perform the expensive task of zeroing out
memory allocated via <b>mmap</b>(2). Balancing these factors
leads to a default setting of 128*1024 for the
<b>M_MMAP_THRESHOLD</b> parameter.</p>

<p style="margin-left:22%; margin-top: 1em">The lower limit
for this parameter is 0. The upper limit is
<b>DEFAULT_MMAP_THRESHOLD_MAX</b>: 512*1024 on 32-bit
systems or <i>4*1024*1024*sizeof(long)</i> on 64-bit
systems.</p>

<p style="margin-left:22%; margin-top: 1em"><i>Note:</i>
Nowadays, glibc uses a dynamic mmap threshold by default.
The initial value of the threshold is 128*1024, but when
blocks larger than the current threshold and less than or
equal to <b>DEFAULT_MMAP_THRESHOLD_MAX</b> are freed, the
threshold is adjusted upwards to the size of the freed
block. When dynamic mmap thresholding is in effect, the
threshold for trimming the heap is also dynamically adjusted
to be twice the dynamic mmap threshold. Dynamic adjustment
of the mmap threshold is disabled if any of the
<b>M_TRIM_THRESHOLD</b>, <b>M_TOP_PAD</b>,
<b>M_MMAP_THRESHOLD</b>, or <b>M_MMAP_MAX</b> parameters is
set.</p>

<p style="margin-left:11%;"><b>M_MXFAST</b> (since glibc
2.3)</p>

<p style="margin-left:22%;">Set the upper limit for memory
allocation requests that are satisfied using
&quot;fastbins&quot;. (The measurement unit for this
parameter is bytes.) Fastbins are storage areas that hold
deallocated blocks of memory of the same size without
merging adjacent free blocks. Subsequent reallocation of
blocks of the same size can be handled very quickly by
allocating from the fastbin, although memory fragmentation
and the overall memory footprint of the program can
increase. The default value for this parameter is
<i>64*sizeof(size_t)/4</i> (i.e., 64 on 32-bit
architectures). The range for this parameter is 0 to
<i>80*sizeof(size_t)/4</i>. Setting <b>M_MXFAST</b> to 0
disables the use of fastbins.</p>

<p style="margin-left:11%;"><b>M_PERTURB</b> (since glibc
2.4)</p>

<p style="margin-left:22%;">If this parameter is set to a
nonzero value, then bytes of allocated memory (other than
allocations via <b>calloc</b>(3)) are initialized to the
complement of the value in the least significant byte of
<i>value</i>, and when allocated memory is released using
<b>free</b>(3), the freed bytes are set to the least
significant byte of <i>value</i>. This can be useful for
detecting errors where programs incorrectly rely on
allocated memory being initialized to zero, or reuse values
in memory that has already been freed.</p>

<p style="margin-left:11%;"><b>M_TOP_PAD</b></p>

<p style="margin-left:22%;">This parameter defines the
amount of padding to employ when calling <b>sbrk</b>(2) to
modify the program break. (The measurement unit for this
parameter is bytes.) This parameter has an effect in the
following circumstances:</p>

<table width="100%" border="0" rules="none" frame="void"
       cellspacing="0" cellpadding="0">
<tr valign="top" align="left">
<td width="22%"></td>
<td width="1%">


<p>*</p></td>
<td width="3%"></td>
<td width="74%">


<p>When the program break is increased, then
<b>M_TOP_PAD</b> bytes are added to the <b>sbrk</b>(2)
request.</p> </td></tr>
<tr valign="top" align="left">
<td width="22%"></td>
<td width="1%">


<p>*</p></td>
<td width="3%"></td>
<td width="74%">


<p>When the heap is trimmed as a consequence of calling
<b>free</b>(3) (see the discussion of
<b>M_TRIM_THRESHOLD</b>) this much free space is preserved
at the top of the heap.</p></td></tr>
</table>

<p style="margin-left:22%; margin-top: 1em">In either case,
the amount of padding is always rounded to a system page
boundary.</p>

<p style="margin-left:22%; margin-top: 1em">Modifying
<b>M_TOP_PAD</b> is a trade-off between increasing the
number of system calls (when the parameter is set low) and
wasting unused memory at the top of the heap (when the
parameter is set high).</p>

<p style="margin-left:22%; margin-top: 1em">The default
value for this parameter is 128*1024.</p>

<p style="margin-left:11%;"><b>M_TRIM_THRESHOLD</b></p>

<p style="margin-left:22%;">When the amount of contiguous
free memory at the top of the heap grows sufficiently large,
<b>free</b>(3) employs <b>sbrk</b>(2) to release this memory
back to the system. (This can be useful in programs that
continue to execute for a long period after freeing a
significant amount of memory.) The <b>M_TRIM_THRESHOLD</b>
parameter specifies the minimum size (in bytes) that this
block of memory must reach before <b>sbrk</b>(2) is used to
trim the heap.</p>

<p style="margin-left:22%; margin-top: 1em">The default
value for this parameter is 128*1024. Setting
<b>M_TRIM_THRESHOLD</b> to &minus;1 disables trimming
completely.</p>

<p style="margin-left:22%; margin-top: 1em">Modifying
<b>M_TRIM_THRESHOLD</b> is a trade-off between increasing
the number of system calls (when the parameter is set low)
and wasting unused memory at the top of the heap (when the
parameter is set high).</p>

<p style="margin-left:11%; margin-top: 1em"><b>Environment
variables</b> <br>
A number of environment variables can be defined to modify
some of the same parameters as are controlled by
<b>mallopt</b>(). Using these variables has the advantage
that the source code of the program need not be changed. To
be effective, these variables must be defined before the
first call to a memory-allocation function. (If the same
parameters are adjusted via <b>mallopt</b>() then the
<b>mallopt</b>() settings take precedence.) For security
reasons, these variables are ignored in set-user-ID and
set-group-ID programs.</p>

<p style="margin-left:11%; margin-top: 1em">The environment
variables are as follows (note the trailing underscore at
the end of the name of each variable): <b><br>
MALLOC_CHECK_</b></p>

<p style="margin-left:22%;">This environment variable
controls the same parameter as <b>mallopt</b>()
<b>M_CHECK_ACTION</b>. If this variable is set to a nonzero
value, then a special implementation of the
memory-allocation functions is used. (This is accomplished
using the <b>malloc_hook</b>(3) feature.) This
implementation performs additional error checking, but is
slower than the standard set of memory-allocation functions.
(This implementation does not detect all possible errors;
memory leaks can still occur.)</p>

<p style="margin-left:22%; margin-top: 1em">The value
assigned to this environment variable should be a single
digit, whose meaning is as described for
<b>M_CHECK_ACTION</b>. Any characters beyond the initial
digit are ignored.</p>

<p style="margin-left:22%; margin-top: 1em">For security
reasons, the effect of <b>MALLOC_CHECK_</b> is disabled by
default for set-user-ID and set-group-ID programs. However,
if the file <i>/etc/suid&minus;debug</i> exists (the content
of the file is irrelevant), then <b>MALLOC_CHECK_</b> also
has an effect for set-user-ID and set-group-ID programs.</p>

<p style="margin-left:11%;"><b>MALLOC_MMAP_MAX_</b></p>

<p style="margin-left:22%;">Controls the same parameter as
<b>mallopt</b>() <b>M_MMAP_MAX</b>.</p>


<p style="margin-left:11%;"><b>MALLOC_MMAP_THRESHOLD_</b></p>

<p style="margin-left:22%;">Controls the same parameter as
<b>mallopt</b>() <b>M_MMAP_THRESHOLD</b>.</p>

<p style="margin-left:11%;"><b>MALLOC_PERTURB_</b></p>

<p style="margin-left:22%;">Controls the same parameter as
<b>mallopt</b>() <b>M_PERTURB</b>.</p>


<p style="margin-left:11%;"><b>MALLOC_TRIM_THRESHOLD_</b></p>

<p style="margin-left:22%;">Controls the same parameter as
<b>mallopt</b>() <b>M_TRIM_THRESHOLD</b>.</p>

<p style="margin-left:11%;"><b>MALLOC_TOP_PAD_</b></p>

<p style="margin-left:22%;">Controls the same parameter as
<b>mallopt</b>() <b>M_TOP_PAD</b>.</p>

<h2>RETURN VALUE
<a name="RETURN VALUE"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">On success,
<b>mallopt</b>() returns 1. On error, it returns 0.</p>

<h2>ERRORS
<a name="ERRORS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">On error,
<i>errno</i> is <i>not</i> set.</p>

<h2>CONFORMING TO
<a name="CONFORMING TO"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">This function
is not specified by POSIX or the C standards. A similar
function exists on many System V derivatives, but the range
of values for <i>param</i> varies across systems. The SVID
defined options <b>M_MXFAST</b>, <b>M_NLBLKS</b>,
<b>M_GRAIN</b>, and <b>M_KEEP</b>, but only the first of
these is implemented in glibc.</p>

<h2>BUGS
<a name="BUGS"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">Specifying an
invalid value for <i>param</i> does not generate an
error.</p>

<p style="margin-left:11%; margin-top: 1em">A calculation
error within the glibc implementation means that a call of
the form:</p>


<p style="margin-left:11%; margin-top: 1em">mallopt(M_MXFAST,
n)</p>

<p style="margin-left:11%; margin-top: 1em">does not result
in fastbins being employed for all allocations of size up to
<i>n</i>. To ensure desired results, <i>n</i> should be
rounded up to the next multiple greater than or equal to
<i>(2k+1)*sizeof(size_t)</i>, where <i>k</i> is an
integer.</p>

<p style="margin-left:11%; margin-top: 1em">The
<b>MALLOC_MMAP_THRESHOLD_</b> and <b>MALLOC_MMAP_MAX_</b>
variables are <i>not</i> ignored in set-group-ID
programs.</p>

<p style="margin-left:11%; margin-top: 1em">If
<b>mallopt</b>() is used to set <b>M_PERTURB</b>, then, as
expected, the bytes of allocated memory are initialized to
the complement of the byte in <i>value</i>, and when that
memory is freed, the bytes of the region are initialized to
the byte specified in <i>value</i>. However, there is an
off-by-<i>sizeof(size_t)</i> error in the implementation:
instead of initializing precisely the block of memory being
freed by the call <i>free(p)</i>, the block starting at
<i>p+sizeof(size_t)</i> is initialized.</p>

<h2>EXAMPLE
<a name="EXAMPLE"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">The program
below demonstrates the use of <b>M_CHECK_ACTION</b>. If the
program is supplied with an (integer) command-line argument,
then that argument is used to set the <b>M_CHECK_ACTION</b>
parameter. The program then allocates a block of memory, and
frees it twice (an error).</p>

<p style="margin-left:11%; margin-top: 1em">The following
shell session shows what happens when we run this program
under glibc, with the default value for
<b>M_CHECK_ACTION</b>:</p>

<p style="margin-left:17%; margin-top: 1em">$
<b>./a.out</b> <br>
main(): returned from first free() call <br>
*** glibc detected *** ./a.out: double free or corruption
(top): 0x09d30008 *** <br>
======= Backtrace: ========= <br>
/lib/libc.so.6(+0x6c501)[0x523501] <br>
/lib/libc.so.6(+0x6dd70)[0x524d70] <br>
/lib/libc.so.6(cfree+0x6d)[0x527e5d] <br>
./a.out[0x80485db] <br>
/lib/libc.so.6(__libc_start_main+0xe7)[0x4cdce7] <br>
./a.out[0x8048471] <br>
======= Memory map: ======== <br>
001e4000&minus;001fe000 r&minus;xp 00000000 08:06 1083555
/lib/libgcc_s.so.1 <br>
001fe000&minus;001ff000 r&minus;&minus;p 00019000 08:06
1083555 /lib/libgcc_s.so.1 <br>
[some lines omitted] <br>
b7814000&minus;b7817000 rw&minus;p 00000000 00:00 0 <br>
bff53000&minus;bff74000 rw&minus;p 00000000 00:00 0 [stack]
<br>
Aborted (core dumped)</p>

<p style="margin-left:11%; margin-top: 1em">The following
runs show the results when employing other values for
<b>M_CHECK_ACTION</b>:</p>

<p style="margin-left:17%; margin-top: 1em">$ <b>./a.out
1</b> # Diagnose error and continue <br>
main(): returned from first free() call <br>
*** glibc detected *** ./a.out: double free or corruption
(top): 0x09cbe008 *** <br>
main(): returned from second free() call <br>
$ <b>./a.out 2</b> # Abort without error message <br>
main(): returned from first free() call <br>
Aborted (core dumped) <br>
$ <b>./a.out 0</b> # Ignore error and continue <br>
main(): returned from first free() call <br>
main(): returned from second free() call</p>

<p style="margin-left:11%; margin-top: 1em">The next run
shows how to set the same parameter using the
<b>MALLOC_CHECK_</b> environment variable:</p>

<p style="margin-left:17%; margin-top: 1em">$
<b>MALLOC_CHECK_=1 ./a.out</b> <br>
main(): returned from first free() call <br>
*** glibc detected *** ./a.out: free(): invalid pointer:
0x092c2008 *** <br>
main(): returned from second free() call</p>

<p style="margin-left:11%; margin-top: 1em"><b>Program
source</b> <br>
#include &lt;malloc.h&gt; <br>
#include &lt;stdio.h&gt; <br>
#include &lt;stdlib.h&gt;</p>

<p style="margin-left:11%; margin-top: 1em">int <br>
main(int argc, char *argv[]) <br>
{ <br>
char *p;</p>

<p style="margin-left:11%; margin-top: 1em">if (argc &gt;
1) { <br>
if (mallopt(M_CHECK_ACTION, atoi(argv[1])) != 1) { <br>
fprintf(stderr, &quot;mallopt() failed&quot;); <br>
exit(EXIT_FAILURE); <br>
} <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">p =
malloc(1000); <br>
if (p == NULL) { <br>
fprintf(stderr, &quot;malloc() failed&quot;); <br>
exit(EXIT_FAILURE); <br>
}</p>

<p style="margin-left:11%; margin-top: 1em">free(p); <br>
printf(&quot;main(): returned from first free()
call\n&quot;);</p>

<p style="margin-left:11%; margin-top: 1em">free(p); <br>
printf(&quot;main(): returned from second free()
call\n&quot;);</p>


<p style="margin-left:11%; margin-top: 1em">exit(EXIT_SUCCESS);
<br>
}</p>

<h2>SEE ALSO
<a name="SEE ALSO"></a>
</h2>



<p style="margin-left:11%; margin-top: 1em"><b>mmap</b>(2),
<b>sbrk</b>(2), <b>mallinfo</b>(3), <b>malloc</b>(3),
<b>malloc_hook</b>(3), <b>malloc_info</b>(3),
<b>malloc_stats</b>(3), <b>malloc_trim</b>(3),
<b>mcheck</b>(3), <b>mtrace</b>(3),
<b>posix_memalign</b>(3)</p>

<h2>COLOPHON
<a name="COLOPHON"></a>
</h2>


<p style="margin-left:11%; margin-top: 1em">This page is
part of release 3.53 of the Linux <i>man-pages</i> project.
A description of the project, and information about
reporting bugs, can be found at
http://www.kernel.org/doc/man&minus;pages/.</p>
<hr>
</body>
</html>
